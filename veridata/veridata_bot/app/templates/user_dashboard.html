{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>Dashboard: {{ instance_name }}</h1>
    <div style="display: flex; gap: 1rem; align-items: center;">
        {% include "partials/global_toggle_btn.html" %}

        <form action="/user/logout" method="post" style="margin: 0;">
            <button type="submit" class="btn btn-secondary">Logout</button>
        </form>
    </div>
</div>

<div class="card" style="margin-bottom: 2rem;">
    <h3 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        Monthly Usage
        <span style="font-size: 0.9em; font-weight: normal; color: var(--text-muted);">Resets: {{ quota.renewal
            }}</span>
    </h3>
    <div
        style="background-color: #f1f5f9; height: 1.25rem; border-radius: 9999px; overflow: hidden; position: relative;">
        {% set percentage = quota.used / quota.limit * 100 if quota.limit > 0 else 0 %}
        {% if percentage > 100 %}{% set percentage = 100 %}{% endif %}

        <div
            style="background-color: {% if percentage >= 100 %}var(--danger-color){% elif percentage > 80 %}#f59e0b{% else %}var(--primary-color){% endif %}; width: {{ percentage }}%; height: 100%; transition: width 0.3s ease;">
        </div>

        <div
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #334155; text-shadow: 0 0 2px rgba(255,255,255,0.8);">
            {{ quota.used }} / {{ quota.limit }}
        </div>
    </div>
</div>

<div class="card">
    <h2 style="margin-top: 0;">Active Conversations</h2>
    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        Here are the users currently interacting with your bot. Use the toggle to Pause (Human Handoff) or Resume the
        bot for each user.
    </p>

    <table>
        <thead>
            <tr>
                <th>Phone Number</th>
                <th>Last Active</th>
                <th style="text-align: center;">Bot Status</th>
            </tr>
        </thead>
        <tbody id="sessions-body">
            {% for session in sessions %}
            {% include "partials/user_session_row.html" %}
            {% else %}
            <tr>
                <td colspan="3" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    No active sessions found.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}